{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'CSS/Navbar.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/CRUD/usuarios.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <script src="https://kit.fontawesome.com/6a284d15f6.js" crossorigin="anonymous"></script>
    <link rel="icon" type="image/x-icon" class="fa-solid fa-shield-halved">
    <title>Ruta en San Bernardo</title>
</head>

<body>

    <nav id="navbar" class="navbar">

        <!-- Botón del menú desplegable -->
        <div class="dropdown">
            <i id="boton-opciones" role="button" class="fa-solid fa-bars dropdown-toggle" onclick="toggleDropdown()">
                <div class="dropdown-menu" id="dropdownMenu">

                    <a href="{% url 'index' %}" class="dropdown-item">
                        <i class="fa-solid fa-map"></i> Mapa
                    </a>
                    <a href="" class="dropdown-item">
                        <i class="fa-solid fa-list"></i> Historial de Alertas
                    </a>
                    <a href="" class="dropdown-item">
                        <i class="fa-solid fa-chart-pie"></i> Graficos
                    </a>

                </div>
            </i>
        </div>

        <h2 class="titulo-pagina">Rutas Seguridad Ciudadana "San Bernardo"</h2>

        <!-- Botón del menú Usuario -->
        <div class="dropdown2">
            <i id="boton-usuario" role="button" class="fa-solid fa-user dropdown-toggle2" onclick="toggleDropdown2()">
                <div class="dropdown-menu2" id="dropdownUsuario">

                    {% if user.is_authenticated %}
                    <div class="user-info">
                        <strong>{{ user.nombre_usuario }} {{ user.apellido_pat_usuario }}</strong>
                        <small>{{ user.id_rol.nombre_rol }}</small>
                    </div>
                    <div class="dropdown-divider"></div>
                    {% endif %}

                    <a href="{% url 'logout' %}" class="dropdown-item2 logout-btn">
                        <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
                    </a>

                    <a href="{% url 'Admin' %}" class="dropdown-item2">
                        <i class="fa-solid fa-list"></i> Historial de Alertas
                    </a>

                </div>
            </i>
        </div>

    </nav>

    <!-- SECCIÓN DE USUARIOS -->
    <div class="usuarios-section">
        <h2 class="section-title">👥 Gestión de Usuarios</h2>

        <!-- Botones de Acción para Usuarios -->
        <div class="usuarios-actions">
            <!-- Agregar Usuario -->
            <div class="usuarios-container">
                <div class="usuarios-header">
                    <button class="btn-agregar-usuario" onclick="abrirModalAgregarUsuario()">
                        <i class="fa-solid fa-user-plus"></i> Agregar Nuevo Usuario
                    </button>
                </div>
            </div>

            <!-- Actualizar Usuario -->
            <div class="usuarios-container">
                <div class="usuarios-header">
                    <button class="btn-actualizar-usuario" onclick="abrirModalActualizarUsuario()">
                        <i class="fa-solid fa-user-edit"></i> Actualizar Usuario Existente
                    </button>
                </div>
            </div>

            <!-- Eliminar Usuario -->
            <div class="usuarios-container">
                <div class="usuarios-header">
                    <button class="btn-eliminar-usuario" onclick="abrirModalEliminarUsuario()">
                        <i class="fa-solid fa-user-times"></i> Eliminar Usuario Existente
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Usuarios -->
        <div class="usuarios-lista" id="usuarios-lista">
            <h3><i class="fa-solid fa-users"></i> Usuarios Registrados en el Sistema</h3>
            <div class="usuarios-stats">
                <div class="stat-card">
                    <i class="fa-solid fa-users"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="total-usuarios">0</span>
                        <span class="stat-label">Total Usuarios</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fa-solid fa-user-shield"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="total-administradores">0</span>
                        <span class="stat-label">Administradores</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fa-solid fa-user-check"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="total-activos">0</span>
                        <span class="stat-label">Usuarios Activos</span>
                    </div>
                </div>
            </div>
            <div id="lista-usuarios" class="lista-usuarios-grid">
                <!-- Los usuarios se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- MODALES DE USUARIOS -->

    <!-- Modal para Agregar Usuario -->
    <div id="modal-agregar-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👤 Agregar Nuevo Usuario</h2>
                <span class="close" onclick="cerrarModalAgregarUsuario()">&times;</span>
            </div>

            <form id="form-agregar-usuario" class="modal-body" onsubmit="guardarUsuario(event)">
                {% csrf_token %}

                <!-- Información Personal -->
                <div class="form-section">
                    <h4>📋 Información Personal</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre-usuario">Nombre:</label>
                            <input type="text" id="nombre-usuario" name="nombre_usuario" placeholder="Ingrese el nombre"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="apellido-pat-usuario">Apellido Paterno:</label>
                            <input type="text" id="apellido-pat-usuario" name="apellido_pat_usuario"
                                placeholder="Ingrese apellido paterno" required>
                        </div>

                        <div class="form-group">
                            <label for="apellido-mat-usuario">Apellido Materno:</label>
                            <input type="text" id="apellido-mat-usuario" name="apellido_mat_usuario"
                                placeholder="Ingrese apellido materno" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="rut-usuario">RUT:</label>
                            <input type="text" id="rut-usuario" name="rut_usuario" placeholder="Ej: 12345678-9"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="telefono-usuario">Teléfono Móvil:</label>
                            <input type="tel" id="telefono-usuario" name="telefono_usuario"
                                placeholder="+56 9 1234 5678" required>
                        </div>
                    </div>
                </div>

                <!-- Información de Cuenta -->
                <div class="form-section">
                    <h4>🔐 Información de Cuenta</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="correo-usuario">Correo Electrónico:</label>
                            <input type="email" id="correo-usuario" name="correo_usuario"
                                placeholder="usuario@ejemplo.com" required>
                        </div>

                        <div class="form-group">
                            <label for="rol-usuario">Rol:</label>
                            <select id="rol-usuario" name="rol_usuario" required>
                                <option value="">Seleccionar Rol</option>
                                <option value="1">Administrador</option>
                                <option value="2">Operador</option>
                                <option value="3">Conductor</option>
                                <option value="4">Inspector</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="password-usuario">Contraseña:</label>
                            <input type="password" id="password-usuario" name="password_usuario"
                                placeholder="Ingrese contraseña" required>
                            <div class="password-strength">
                                <div class="strength-bar"></div>
                                <small>La contraseña debe tener al menos 8 caracteres</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmar-password">Confirmar Contraseña:</label>
                            <input type="password" id="confirmar-password" name="confirmar_password"
                                placeholder="Confirme la contraseña" required>
                            <div class="password-match">
                                <small>Las contraseñas deben coincidir</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información Adicional -->
                <div class="form-section">
                    <h4>⚙️ Información Adicional</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="turno-usuario">Turno:</label>
                            <select id="turno-usuario" name="turno_usuario">
                                <option value="">Seleccionar Turno</option>
                                <option value="1">Día (8am-3pm)</option>
                                <option value="2">Tarde (3pm-10pm)</option>
                                <option value="3">Noche (10pm-8am)</option>
                                <option value="4">Inspector Día (6am-3pm)</option>
                                <option value="5">Inspector Tarde (3pm-12am)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="estado-usuario">Estado:</label>
                            <select id="estado-usuario" name="estado_usuario" required>
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancelar" onclick="cerrarModalAgregarUsuario()">Cancelar</button>
                    <button type="submit" class="btn-guardar">
                        <i class="fa-solid fa-user-plus"></i> Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Actualizar Usuario -->
    <div id="modal-actualizar-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ Actualizar Usuario</h2>
                <span class="close" onclick="cerrarModalActualizarUsuario()">&times;</span>
            </div>

            <form id="form-actualizar-usuario" class="modal-body" onsubmit="actualizarUsuarioExistente(event)">
                {% csrf_token %}

                <!-- Búsqueda de Usuario -->
                <div class="form-section">
                    <h4>🔍 Buscar Usuario</h4>
                    <div class="search-container">
                        <input type="text" id="buscar-usuario-actualizar"
                            placeholder="Buscar por nombre, email o RUT..." class="search-input"
                            onkeyup="buscarUsuariosActualizar()">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    </div>
                    <div id="lista-usuarios-actualizar" class="usuarios-list-search"></div>
                </div>

                <!-- Información del Usuario Seleccionado -->
                <div id="info-usuario-seleccionado" class="usuario-info-section" style="display: none;">
                    <h4>📋 Usuario Seleccionado</h4>
                    <div class="usuario-details">
                        <div class="detail-row">
                            <strong>Nombre:</strong>
                            <span id="usuario-nombre-completo"></span>
                        </div>
                        <div class="detail-row">
                            <strong>RUT:</strong>
                            <span id="usuario-rut"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Correo:</strong>
                            <span id="usuario-correo"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Rol:</strong>
                            <span id="usuario-rol-actual" class="rol-badge"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Estado:</strong>
                            <span id="usuario-estado-actual" class="estado-badge"></span>
                        </div>
                    </div>
                </div>

                <!-- Formulario de Edición -->
                <div id="form-edicion-usuario" class="form-edicion-section" style="display: none;">
                    <h4>✏️ Editar Información</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editar-nombre">Nombre:</label>
                            <input type="text" id="editar-nombre" name="editar_nombre" required>
                        </div>

                        <div class="form-group">
                            <label for="editar-apellido-pat">Apellido Paterno:</label>
                            <input type="text" id="editar-apellido-pat" name="editar_apellido_pat" required>
                        </div>

                        <div class="form-group">
                            <label for="editar-apellido-mat">Apellido Materno:</label>
                            <input type="text" id="editar-apellido-mat" name="editar_apellido_mat" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editar-rut">RUT:</label>
                            <input type="text" id="editar-rut" name="editar_rut" readonly
                                style="background-color: #f8f9fa;">
                            <small class="text-muted">El RUT no se puede modificar</small>
                        </div>

                        <div class="form-group">
                            <label for="editar-telefono">Teléfono Móvil:</label>
                            <input type="tel" id="editar-telefono" name="editar_telefono" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editar-correo">Correo Electrónico:</label>
                            <input type="email" id="editar-correo" name="editar_correo" required>
                        </div>

                        <div class="form-group">
                            <label for="editar-rol">Rol:</label>
                            <select id="editar-rol" name="editar_rol" required>
                                <option value="1">Administrador</option>
                                <option value="2">Operador</option>
                                <option value="3">Conductor</option>
                                <option value="4">Inspector</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editar-turno">Turno:</label>
                            <select id="editar-turno" name="editar_turno">
                                <option value="">Sin turno asignado</option>
                                <option value="1">Día (8am-3pm)</option>
                                <option value="2">Tarde (3pm-10pm)</option>
                                <option value="3">Noche (10pm-8am)</option>
                                <option value="4">Inspector Día (6am-3pm)</option>
                                <option value="5">Inspector Tarde (3pm-12am)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editar-estado">Estado:</label>
                            <select id="editar-estado" name="editar_estado" required>
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cambio de Contraseña (Opcional) -->
                    <div class="form-section password-change-section">
                        <h5>🔒 Cambiar Contraseña (Opcional)</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nueva-password">Nueva Contraseña:</label>
                                <input type="password" id="nueva-password" name="nueva_password"
                                    placeholder="Dejar vacío para mantener la actual">
                                <div class="password-strength">
                                    <div class="strength-bar"></div>
                                    <small>La contraseña debe tener al menos 8 caracteres</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="confirmar-nueva-password">Confirmar Nueva Contraseña:</label>
                                <input type="password" id="confirmar-nueva-password" name="confirmar_nueva_password"
                                    placeholder="Confirme la nueva contraseña">
                                <div class="password-match">
                                    <small>Las contraseñas deben coincidir</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancelar"
                        onclick="cerrarModalActualizarUsuario()">Cancelar</button>
                    <button type="submit" class="btn-actualizar" id="btn-actualizar-usuario" disabled>
                        <i class="fa-solid fa-floppy-disk"></i> Actualizar Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Eliminar Usuario -->
    <div id="modal-eliminar-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header header-eliminar">
                <h2>🗑️ Eliminar Usuario</h2>
                <span class="close" onclick="cerrarModalEliminarUsuario()">&times;</span>
            </div>

            <div class="modal-body">
                {% csrf_token %}

                <!-- Búsqueda de Usuario a Eliminar -->
                <div class="form-section">
                    <h4>🔍 Buscar Usuario a Eliminar</h4>
                    <div class="search-container">
                        <input type="text" id="buscar-usuario-eliminar" placeholder="Buscar por nombre, email o RUT..."
                            class="search-input" onkeyup="buscarUsuariosEliminar()">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    </div>
                    <div id="lista-usuarios-eliminar" class="usuarios-list-search"></div>
                </div>

                <!-- Información del Usuario a Eliminar -->
                <div id="info-usuario-eliminar" class="usuario-eliminar-info" style="display: none;">
                    <h4>⚠️ Usuario Seleccionado para Eliminar</h4>
                    <div class="usuario-details-eliminar">
                        <div class="detail-row">
                            <strong>Nombre:</strong>
                            <span id="usuario-eliminar-nombre"></span>
                        </div>
                        <div class="detail-row">
                            <strong>RUT:</strong>
                            <span id="usuario-eliminar-rut"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Correo:</strong>
                            <span id="usuario-eliminar-correo"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Rol:</strong>
                            <span id="usuario-eliminar-rol" class="rol-badge"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Estado:</strong>
                            <span id="usuario-eliminar-estado" class="estado-badge"></span>
                        </div>
                    </div>

                    <div class="advertencia-eliminacion">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <div>
                            <strong>¡ADVERTENCIA!</strong>
                            <p>Esta acción eliminará permanentemente al usuario del sistema.</p>
                            <p class="texto-peligro">Esta acción no se puede deshacer.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancelar" onclick="cerrarModalEliminarUsuario()">Cancelar</button>
                    <button type="button" class="btn-eliminar-confirmar" id="btn-confirmar-eliminar-usuario" disabled
                        onclick="confirmarEliminarUsuario()">
                        <i class="fa-solid fa-trash"></i> Eliminar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'JavaScript/Redirecciones.js' %}"></script>
    <script src="{% static 'JavaScript/CRUD/Usuarios/Usuarios_Agregar.js' %}"></script>
    <script src="{% static 'JavaScript/CRUD/Usuarios/Usuarios_Actualizar.js' %}"></script>
    <script src="{% static 'JavaScript/CRUD/Usuarios/Usuarios_Eliminar.js' %}"></script>
    <script src="{% static 'JavaScript/CRUD/Usuarios/Usuarios_Listar.js' %}"></script>
</body>

</html>